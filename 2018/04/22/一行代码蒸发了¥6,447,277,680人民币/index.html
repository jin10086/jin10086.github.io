<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>一行代码蒸发了¥6,447,277,680人民币！ | 高金的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="现在进入你还是先行者，最后观望者进场才是韭菜。  美图董事长蔡文胜曾在三点钟群，高调的说出了这句话，随即被大众疯传。  在他发表完言论没多久，2月美链（BEC）上交易所会暴涨4000%，后又暴跌。尽管他多次否认，聪明的网友早已扒出，他与BEC千丝万缕的关系。  庄家坐庄操控币价，美图的股价随之暴涨，蔡文胜顺利完成了他的韭菜收割大计。  但在币圈，割人者，人恒割之。  随着BEC智能合约的漏洞的爆出"><meta name="keywords" content="区块链"><meta property="og:type" content="article"><meta property="og:title" content="一行代码蒸发了¥6,447,277,680人民币！"><meta property="og:url" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/index.html"><meta property="og:site_name" content="高金的博客"><meta property="og:description" content="现在进入你还是先行者，最后观望者进场才是韭菜。  美图董事长蔡文胜曾在三点钟群，高调的说出了这句话，随即被大众疯传。  在他发表完言论没多久，2月美链（BEC）上交易所会暴涨4000%，后又暴跌。尽管他多次否认，聪明的网友早已扒出，他与BEC千丝万缕的关系。  庄家坐庄操控币价，美图的股价随之暴涨，蔡文胜顺利完成了他的韭菜收割大计。  但在币圈，割人者，人恒割之。  随着BEC智能合约的漏洞的爆出"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/0.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/1.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/2.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/3.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/4.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/5.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/6.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/7.jpg"><meta property="og:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/8.jpg"><meta property="og:updated_time" content="2018-10-11T17:11:19.479Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一行代码蒸发了¥6,447,277,680人民币！"><meta name="twitter:description" content="现在进入你还是先行者，最后观望者进场才是韭菜。  美图董事长蔡文胜曾在三点钟群，高调的说出了这句话，随即被大众疯传。  在他发表完言论没多久，2月美链（BEC）上交易所会暴涨4000%，后又暴跌。尽管他多次否认，聪明的网友早已扒出，他与BEC千丝万缕的关系。  庄家坐庄操控币价，美图的股价随之暴涨，蔡文胜顺利完成了他的韭菜收割大计。  但在币圈，割人者，人恒割之。  随着BEC智能合约的漏洞的爆出"><meta name="twitter:image" content="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/0.jpg"><link rel="alternate" href="/atom.xml" title="高金的博客" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/mycdn@2.0.0/static/css/style.min.css"><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-113457160-1","auto"),ga("send","pageview")</script><script async src="https://rum.perfops.net/rum3.min.js"></script></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-inner" class="inner"><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="搜索"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://igaojin.me"></form></div><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">首页</a> <a class="main-nav-link" href="/archives">归档</a> <a class="main-nav-link" href="/about">关于我</a> <a class="main-nav-link" href="/lab/">实验室</a> <a class="main-nav-link" href="/buy-me-a-coffee/">赞赏</a></nav></div><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">高金的博客</a></h1></div></div></header><div class="outer"><section id="main"><article id="post-一行代码蒸发了¥6,447,277,680人民币" class="article article-type-post" itemscope="" itemprop="blogPost"><div class="article-meta"><a href="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/" class="article-date"><time datetime="2018-04-22T15:24:05.000Z" itemprop="datePublished">2018-04-22</time></a></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">一行代码蒸发了¥6,447,277,680人民币！</h1></header><div class="article-entry" itemprop="articleBody"><p><strong>现在进入你还是先行者，最后观望者进场才是韭菜。</strong></p><p>美图董事长蔡文胜曾在三点钟群，高调的说出了这句话，随即被大众疯传。</p><p>在他发表完言论没多久，2月美链（BEC）上交易所会暴涨4000%，后又暴跌。尽管他多次否认，聪明的网友早已扒出，他与BEC千丝万缕的关系。</p><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/0.jpg"><p>庄家坐庄操控币价，美图的股价随之暴涨，蔡文胜顺利完成了他的韭菜收割大计。</p><p>但在币圈，割人者，人恒割之。</p><p>随着BEC智能合约的漏洞的爆出，被黑客利用，瞬间套现抛售大额BEC，6亿在瞬间归零。</p><p>而这一切，竟然是因为一个简单至极的程序Bug。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>今天有人在群里说，<a href="https://etherscan.io/address/0xc5d105e63711398af9bbff092d4b6769c82f793d" rel="external nofollow noopener noreferrer" target="_blank">Beauty Chain 美蜜</a> 代码里面有bug，已经有人利用该bug获得了 57,896,044,618,658,100,000,000,000,000,000,000,000,000,000,000,000,000,000,000.792003956564819968 个 BEC</p><p>那笔操作记录是 <a href="https://etherscan.io/tx/0xad89ff16fd1ebe3a0a7cf4ed282302c06626c1af33221ebe0d3a470aba4a660f" rel="external nofollow noopener noreferrer" target="_blank">0xad89ff16fd1ebe3a0a7cf4ed282302c06626c1af33221ebe0d3a470aba4a660f</a></p><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/1.jpg"><p>下面我来带大家看看，黑客是如何实现的！</p><p>我们可以看到执行的方法是 <code>batchTransfer</code></p><p>那这个方法是干嘛的呢？（给指定的几个地址，发送相同数量的代币）</p><h3 id="整体逻辑是"><a href="#整体逻辑是" class="headerlink" title="整体逻辑是"></a>整体逻辑是</h3><p>你传几个地址给我(_receivers),然后再传给我你要给每个人多少代币（_value)</p><p>然后你要发送的总金额 = 发送的人数* 发送的金额</p><p>然后 要求你当前的余额大于 发送的总金额</p><p>然后扣掉你发送的总金额</p><p>然后 给_receivers 里面的每个人发送 指定的金额（_value)</p><p>从逻辑上看，这边是没有任何问题的，你想给别人发送代币，那么你本身的余额一定要大于发送的总金额的！</p><p>但是这段代码却犯了一个很傻的错!</p><h2 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h2><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/2.jpg"><p>这个方法会传入两个参数</p><ol><li>_receivers</li><li>_value</li></ol><p>_receivers 的值是个列表，里面有两个地址</p><p><a href="https://etherscan.io/token/0xc5d105e63711398af9bbff092d4b6769c82f793d?a=0x0e823ffe018727585eaf5bc769fa80472f76c3d7" rel="external nofollow noopener noreferrer" target="_blank">0x0e823ffe018727585eaf5bc769fa80472f76c3d7</a></p><p><a href="https://etherscan.io/token/0xc5d105e63711398af9bbff092d4b6769c82f793d?a=0xb4d30cac5124b46c2df0cf3e3e1be05f42119033" rel="external nofollow noopener noreferrer" target="_blank">0xb4d30cac5124b46c2df0cf3e3e1be05f42119033</a></p><p>_value 的值是 <code>8000000000000000000000000000000000000000000000000000000000000000</code></p><p>我们再查看代码（如下图）</p><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/3.jpg"><p>我们一行一行的来解释</p><p><code>uint cnt = _receivers.length;</code></p><p>是获取 _receivers 里面有几个地址，我们从上面可以看到 参数里面只有两个地址，所以 cnt=2，也就是 给两个地址发送代币</p><p><code>uint256 amount = uint256(cnt) * _value;</code></p><h2 id="uint256"><a href="#uint256" class="headerlink" title="uint256"></a>uint256</h2><p>首先<code>uint256(cnt)</code> 是把cnt 转成了 uint256类型</p><p>那么,什么是uint256类型？或者说uint256类型的取值范围是多少…</p><p>uintx 类型的取值范围是 0 到 2的x次方 -1</p><p>也就是 假如是 uint8的话</p><p>则 uint8的取值范围是 0 到 2的8次方 -1</p><p>也就是 0 到255</p><p>那么uint256 的取值范围是</p><p>0 - 2的256次方-1 也就是 <code>0 到115792089237316195423570985008687907853269984665640564039457584007913129639935</code></p><p>python 算 2的256次方是多少<br><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/4.jpg"></p><p>那么假如说 设置的值超过了 取值范围怎么办？这种情况称为<code>溢出</code></p><p>举个例子来说明</p><p>因为uint256的取值太大了，所以用uint8来 举例。。。</p><p>从上面我们已经知道了 uint8 最小是0，最大是255</p><p>那么当我 255 + 1 的时候，结果是啥呢？<strong>结果会变成0</strong></p><p>那么当我 255 + 2 的时候，结果是啥呢？<strong>结果会变成1</strong></p><p>那么当我 0 - 1 的时候，结果是啥呢？<strong>结果会变成255</strong></p><p>那么当我 0 - 2 的时候，结果是啥呢？<strong>结果会变成255</strong></p><p>那么 我们回到上面的代码中，</p><p><code>amount = uint256(cnt) * _value</code></p><p>则 amount = 2* _value</p><p>但是此时 _value 是16进制的，我们把他转成 10进制</p><p>（python 16进制转10进制）<br><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/5.jpg"></p><p>可以看到 _value = <code>57896044618658097711785492504343953926634992332820282019728792003956564819968</code></p><p>那么amount = _value*2 = <code>115792089237316195423570985008687907853269984665640564039457584007913129639936</code></p><p>可以在查看上面看到 uint256取值范围最大为 <code>115792089237316195423570985008687907853269984665640564039457584007913129639935</code></p><p>此时，amout已经超过了最大值，溢出 则<code>amount = 0</code></p><p>下一行代码<br><code>require(cnt &gt; 0 &amp;&amp; cnt &lt;= 20);</code><br>require 语句是表示该语句一定要是正确的，也就是 cnt 必须大于0 且 小于等于20</p><p>我们的cnt等于2，通过!</p><p><code>require(_value &gt; 0 &amp;&amp; balances[msg.sender] &gt;= amount);</code></p><p>这句要求 _value 大于0，我们的_value是大于0 的<br>且,当前用户拥有的代币余额大于等于 amount,因为amount等于0，所以 就算你一个代币没有，也是满足的！</p><p><code>balances[msg.sender] = balances[msg.sender].sub(amount);</code></p><p>这句是当前用户的余额 - amount</p><p>当前amount 是0，所以当前用户代币的余额没有变动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for (uint i = 0; i &lt; cnt; i++) &#123;</span><br><span class="line">    balances[_receivers[i]] = balances[_receivers[i]].add(_value);</span><br><span class="line">    Transfer(msg.sender, _receivers[i], _value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这句是遍历 _receivers中的地址，<br>对每个地址做以下操作</p><p><code>balances[_receivers[i]] = balances[_receivers[i]].add(_value);</code><br>_receivers中的地址 的余额 = 原本余额+value</p><p>所以 _receivers 中地址的余额 则加了57896044618658097711785492504343953926634992332820282019728792003956564819968 个代币！！！</p><p><code>Transfer(msg.sender, _receivers[i], _value); }</code><br>这句则只是把赠送代币的记录存下来！！！</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>就一个简单的溢出漏洞，导致BEC代币的市值接近归0</p><p>那么，开发者有没有考虑到溢出问题呢？</p><p>其实他考虑了,</p><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/6.jpg"><p>可以看如上截图</p><p>除了amount的计算外, 其他的给用户转钱 都用了safeMath 的方法（sub,add)</p><p>那么 为啥就偏偏这一句没有用safeMath的方法呢。。。</p><p>这就要用写代码的人了。。。</p><h2 id="啥是safeMath"><a href="#啥是safeMath" class="headerlink" title="啥是safeMath"></a>啥是safeMath</h2><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/7.jpg"><p>safeMath 是为了计算安全 而写的一个library</p><p>我们看看他干了啥？为啥能保证计算安全.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function mul(uint256 a, uint256 b) internal constant returns (uint256) &#123;</span><br><span class="line">uint256 c = a * b;</span><br><span class="line">assert(a == 0 || c / a == b);</span><br><span class="line">return c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上面的乘法.<br>他在计算后，用assert 验证了下结果是否正确！</p><p>如果在上面计算 amount的时候，用了 mul的话，<br>则 <code>c / a == b</code><br>也就是 验证 amount / cnt == _value</p><p>这句会执行报错的，因为 0 / cnt 不等于 _value</p><p>所以程序会报错！</p><p>也就不会发生溢出了…</p><p>那么 还有一个小问题，这里的<code>assert</code> 好 <code>require</code> 好像是干的同一件事</p><p>都是为了验证 某条语句是否正确！</p><p>那么他俩有啥区别呢？</p><p>用了assert的话，则程序的gas limit 会消耗完毕</p><p>而require的话，则只是消耗掉当前执行的gas</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>那么 我们如何避免这种问题呢？</p><p>我个人看法是</p><ol><li>只要涉及到计算，一定要用safeMath</li><li>代码一定要测试！</li><li>代码一定要review！</li><li>必要时，要请专门做代码审计的公司来 测试代码</li></ol><p>这件事后需要如何处理呢？</p><p>目前，该方法已经暂停了（还好可以暂停）所以看过文章的朋友 不要去测试了…</p><img src="/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/8.jpg"><p>不过已经发生了的事情咋办呢？</p><p>我的想法是，快照在漏洞之前，所有用户的余额情况</p><p>然后发行新的token，给之前的用户 发送等额的代币…</p><p><br><strong>本文作者</strong>：高金<br><strong>本文地址</strong>： <a href="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/">https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/</a><br><strong>版权声明</strong>：转载请注明出处！</p></div><footer class="article-footer"><a data-url="https://igaojin.me/2018/04/22/一行代码蒸发了¥6,447,277,680人民币/" data-id="ck3ayrx010011ynyp87k1my8o" class="article-share-link">分享</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/区块链/">区块链</a></li></ul></footer></div><script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><div id="random_posts"><h2>推荐文章</h2><div class="random_posts_ul"><script>var random_count=4,site={BASE_URI:"/"};function load_random_posts(t){var s=site.posts;if(t){for(var o,r,a=s.length;a;o=Math.floor(Math.random()*a),r=s[--a],s[a]=s[o],s[o]=r);s=s.slice(0,random_count);for(var e="<ul>",n=0;n<s.length;n++){var i=s[n];e+="<li><strong>"+i.date+':&nbsp;&nbsp;<a href="'+(site.BASE_URI+i.uri)+'">'+(i.title||i.uri)+"</a></strong>",i.excerpt&&(e+='<div class="post-excerpt">'+i.excerpt+"</div>"),e+="</li>"}$(t).html(e+"</ul>")}}$(".random_posts_ul").each(function(){var s=this;site.posts&&site.posts.length?load_random_posts(s):$.getJSON(site.BASE_URI+"js/posts.js",function(t){site.posts=t,load_random_posts(s)})})</script></div></div><nav id="article-nav"><a href="/2018/04/25/一键上链/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title">一键上链</div></a><a href="/2018/03/22/带你发现好游戏/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">爬虫带你发现区块链好游戏</div></a></nav></article><div class="comments" id="comments"><div id="gitment_comments"></div></div></section><aside id="sidebar"><div class="widget-wrap"><div class="widget" id="toc-widget-fixed"><strong class="toc-title">文章目录</strong><div class="toc-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#整体逻辑是"><span class="toc-number">1.1.</span> <span class="toc-text">整体逻辑是</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码解释"><span class="toc-number">2.</span> <span class="toc-text">代码解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uint256"><span class="toc-number">3.</span> <span class="toc-text">uint256</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#啥是safeMath"><span class="toc-number">5.</span> <span class="toc-text">啥是safeMath</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结-1"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-left">&copy; 2014 - 2019 Gao JIn&nbsp;|&nbsp; 主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank" rel="external nofollow noopener noreferrer">Cafe</a></div><div id="footer-right">联系方式&nbsp;|&nbsp; igaojin@qq.com</div></div></footer><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">首页</a> <a href="/archives" class="mobile-nav-link">归档</a> <a href="/about" class="mobile-nav-link">关于我</a> <a href="/lab/" class="mobile-nav-link">实验室</a> <a href="/buy-me-a-coffee/" class="mobile-nav-link">赞赏</a></nav><img class="back-to-top-btn" src="/images/fly-to-top.png"><script>window.onload=function(){new Elevator({selector:".back-to-top-btn",element:document.querySelector(".back-to-top-btn"),duration:1e3})}</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitment@0.0.3/style/default.css"><script src="//cdn.jsdelivr.net/npm/gitment@0.0.3/dist/gitment.browser.js"></script><script>var gitment=new Gitment({id:"Sun Apr 22 2018 23:24:05 GMT+0800",owner:"jin10086",repo:"jin10086.github.io",oauth:{client_id:"935e92a5333436856348",client_secret:"e655566eaf920d216ec6283978d67874bf0850a6"}});gitment.render(document.getElementById("gitment_comments"))</script><script src="//cdn.jsdelivr.net/npm/mycdn@2.0.0/static/js/is.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css"><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="//cdn.jsdelivr.net/npm/mycdn@2.0.0/static/js/script.js"></script><script src="//cdn.jsdelivr.net/npm/mycdn@2.0.0/static/js/elevator.js"></script></div></body>